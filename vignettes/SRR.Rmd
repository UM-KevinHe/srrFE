---
title: "Getting Started with srrFE"
author: "Yubo Shao"
date: <span style="font-style:normal;font-family:'Open Sans'">`r Sys.Date()`</span>
output: 
  rmarkdown::html_vignette:
    self_contained: yes
    mode: selfcontained
vignette: >
  %\VignetteIndexEntry{Getting Started with srrFE}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

<style>
body {
  text-align: justify
}
</style>

## Introduction:

The `srrFE` software package is designed to implement the SerBIN method proposed by Wu et al. (2022) (doi:10.1002/sim.9387), specifically tailored to address the computational challenges inherent in large-scale provider data.  Additionally, the package is equipped with functions designed to estimate standardized ratios and rates and conduct hypothesis testing.

In this vignette, we will explore the fundamental usage of the functions integrated into the current R package. For more details, please consult the `Reference` section. To learn the algorithms employed by `srrFE`, refer to the `Articles/Models` section or see the original articles:

* [Wu, W., Yang, Y., Kang, J., & He, K. (2022). Improving large‚Äêscale estimation and inference for profiling health care providers. Statistics in Medicine, 41(15), 2840-2853.](https://onlinelibrary.wiley.com/doi/full/10.1002/sim.9387)
* [He, K., Kalbfleisch, J. D., Li, Y., & Li, Y. (2013). Evaluating hospital readmission rates in dialysis facilities; adjusting for hospital effects. Lifetime Data Analysis, 19, 490-512.](https://link.springer.com/article/10.1007/s10985-013-9264-6)

## Installation:

```{r ,include=TRUE,eval=FALSE}
require("devtools")
require("remotes")
remotes::install_github("UM-KevinHe/srrFE", ref = "main")
```


## Example

We will employ a simulated dataset contained in the current package to illustrate how to utilize this package for data analysis. The data named `data_FE` includes the information of:

* Y: the binary outcome variable

* ID: facility indicator

* Z: 4 continuous covariates

```{r}
library(SRR)
data(data_FE)
```

### Data Preparation Function

Typically, users should employ the `fe_data_prep()` function to preprocess their data. We advise users to review the data and consider making adjustments based on the output information if necessary. Please know that the subsequent functions should be used based on the processed data.

```{r}
data.prep <- fe_data_prep(data_FE$Y, data_FE$Z, data_FE$ID)
head(data.prep$data)
```

### Model Fitting

The `logis_fe()` function is employed to fit the fixed effect model. In the first three argument positions of this function, users are required to supply the object generated from previous `fe_data_prep()` function.

```{r}
fit_fe <- logis_fe(data.prep, message = T)
```

Users most commonly utilize the output to obtain estimates of the facility effects and covariate coefficients by `coef()` function.

```{r}
coef(fit_fe)
```

### Measures Output

Based on the results obtained from the fitted model, users can easily calculate direct or indirect standardized rates and ratios as per their specific requirements. The `SR_output()` function simply necessitates the users to input the object returned from the preceding `logis_fe()` function and specify the desired type of measure. By default, both indirect standardized rate and indirect standardized ratio will be provided.

```{r}
SR <- SR_output(fit_fe)
SR$indirect.rate
SR$indirect.ratio
```

### Hypothesis Testing for Facility Effects

The `test_fe()` function provides hypothesis testing outcomes to assist users in identifying outlier facilities with extreme outcomes. By default, we utilize the median of all estimated facility effects as the null value (i.e. $H_0: \gamma_i = \hat{\gamma}_{med}$). Users have the flexibility to select from various testing methods, including "exact.poisbinom" (default), "exact.binom", "exact.bootstrap", "score", and "wald". 

```{r}
test_poisbinom <- test_fe(fit_fe)
test_poisbinom
```
The function returns a 3-column dataframe, with the "flag" column indicating whether a facility is flagged (where 0 denotes that the facility is not flagged, and 1 or -1 represents outlier facilities based on the user's data interpretation). The last two columns contain p-values and their corresponding test statistics.

### Hypothesis Testing for Covariate Coefficients

Additionally, we offer the `summary_fe_covar()` function, which provides the test statistics for the covariate coefficients. The test statistics can be calculated by the "wald test" (`"wald.cpp"` or `"wald"` option), "score test" (`"score"` option), or "likelihood ratio test" (`"lr"` option). 


```{r}
summary_fe_covar(fit_fe)
```

The returned dataframe includes the estimates of the covariate coefficients and their corresponding p-values. Furthermore, the Wald test offers additional confidence intervals.

### Confidence Interval for Facility Effects

The `confint()` function can be used to provide the confidence intervals for the facility effects (i.e. $\gamma_i$) for each facilities selected to be tested. User needs to explicitly specify `option = "gamma"`.

Users can choose the method for generating confidence intervals from either `"exact"`, `"wald"`, or `"score"` test. To maintain consistency between the confidence interval (CI) and the previous test results, it is advisable to use the same test option for both the `test_fe()` and `confint()` functions. Please note that the `"exact"` option in the `test_fe()` function corresponds to the `"exact.poisbinom"` option in the `test_fe()` function.

```{r}
confint(fit_fe, option = "gamma")
```

The returned data frame offers estimates of the facility effects, and both upper and lower limits of the CIs (defaulting to a 95% confidence level on both sides).


### Confidence Interval for Measures

For users interested in the CIs of direct/indirect standardized rates or ratios, the `confint()` function can be also used for this purpose with explicitly specify `option = "SR"`. Additionally, users should input the object returned from the `logis_fe()` function and specify the desired type of measure. By default, both indirect standardized rate and indirect standardized ratio will be provided.

```{r}
confint(fit_fe, option = "SR")
```

Similarly, the function will return a three-column data frame that provides an estimate of the selected measure along with its corresponding upper and lower bounds of the CIs.

